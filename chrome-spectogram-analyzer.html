<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Natural Sound Spectrogram - Savo Studio</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(45deg, #74ebd5, #acb6e5, #ff9a9e, #fecfef);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease infinite;
            margin-bottom: 10px;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .main-panel {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 20px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 20px;
        }

        .control-group h3 {
            color: #74ebd5;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .sound-presets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .sound-preset {
            background: linear-gradient(45deg, rgba(116, 235, 213, 0.1), rgba(172, 182, 229, 0.1));
            border: 2px solid rgba(116, 235, 213, 0.3);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9rem;
        }

        .sound-preset:hover {
            background: linear-gradient(45deg, rgba(116, 235, 213, 0.2), rgba(172, 182, 229, 0.2));
            border-color: #74ebd5;
            transform: translateY(-2px);
        }

        .sound-preset.active {
            background: linear-gradient(45deg, rgba(116, 235, 213, 0.3), rgba(172, 182, 229, 0.3));
            border-color: #74ebd5;
            box-shadow: 0 0 20px rgba(116, 235, 213, 0.4);
        }

        .spectrogram-container {
            background: #000;
            border-radius: 15px;
            border: 2px solid rgba(116, 235, 213, 0.3);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .spectrogram-canvas {
            width: 100%;
            height: 400px;
            display: block;
        }

        .frequency-labels {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background: rgba(0,0,0,0.5);
            font-size: 0.8rem;
            color: #74ebd5;
        }

        .analysis-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .info-card {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .info-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #74ebd5;
            margin-bottom: 5px;
        }

        .info-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #74ebd5, #acb6e5);
            color: #1a1a2e;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .file-input {
            display: none;
        }

        .upload-area {
            border: 2px dashed rgba(116, 235, 213, 0.3);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            border-color: #74ebd5;
            background: rgba(116, 235, 213, 0.1);
        }

        .upload-area.dragover {
            border-color: #acb6e5;
            background: rgba(172, 182, 229, 0.2);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
            
            .sound-presets {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéµ Natural Sound Spectrogram</h1>
            <p class="subtitle">Chrome Music Lab inspired frequency visualization for bird calls, instruments & natural sounds</p>
        </div>

        <div class="main-panel">
            <div class="controls">
                <div class="control-group">
                    <h3>üê¶ Bird Calls</h3>
                    <div class="sound-presets">
                        <div class="sound-preset" onclick="generateBirdCall('robin');">üê¶ Robin</div>
                        <div class="sound-preset" onclick="generateBirdCall('sparrow');">üê¶ Sparrow</div>
                        <div class="sound-preset" onclick="generateBirdCall('cardinal');">üî¥ Cardinal</div>
                        <div class="sound-preset" onclick="generateBirdCall('owl');">ü¶â Owl</div>
                        <div class="sound-preset" onclick="generateBirdCall('canary');">üü° Canary</div>
                        <div class="sound-preset" onclick="generateBirdCall('crow');">‚ö´ Crow</div>
                        <div class="sound-preset" onclick="generateBirdCall('bluejay');">üíô Blue Jay</div>
                        <div class="sound-preset" onclick="generateBirdCall('mockingbird');">üé≠ Mockingbird</div>
                        <div class="sound-preset" onclick="generateBirdCall('wren');">ü§é Wren</div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>üéª Instruments</h3>
                    <div class="sound-presets">
                        <div class="sound-preset" onclick="generateSpectrogram('violin')">üéª Violin</div>
                        <div class="sound-preset" onclick="generateSpectrogram('piano')">üéπ Piano</div>
                        <div class="sound-preset" onclick="generateSpectrogram('flute')">ü™à Flute</div>
                        <div class="sound-preset" onclick="generateSpectrogram('guitar')">üé∏ Guitar</div>
                        <div class="sound-preset" onclick="generateSpectrogram('trumpet')">üé∫ Trumpet</div>
                        <div class="sound-preset" onclick="generateSpectrogram('cello')">üéª Cello</div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>üåä Natural Sounds</h3>
                    <div class="sound-presets">
                        <div class="sound-preset" onclick="generateSpectrogram('whistle')">üí® Whistling</div>
                        <div class="sound-preset" onclick="generateSpectrogram('glass')">üç∑ Wine Glass</div>
                        <div class="sound-preset" onclick="generateSpectrogram('water')">üíß Water Drop</div>
                        <div class="sound-preset" onclick="generateSpectrogram('wind')">üå¨Ô∏è Wind</div>
                        <div class="sound-preset" onclick="generateSpectrogram('rain')">üåßÔ∏è Rain</div>
                        <div class="sound-preset" onclick="generateSpectrogram('thunder')">‚ö° Thunder</div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>üìÅ Audio Upload</h3>
                    <div class="upload-area" id="uploadArea">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üéµ</div>
                        <div>Drop audio files here or click to browse</div>
                        <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 8px;">
                            Supports MP3, WAV, M4A formats
                        </div>
                    </div>
                    <input type="file" id="fileInput" class="file-input" accept="audio/*">
                    <button class="btn btn-primary" onclick="startMicrophone()">üé§ Use Microphone</button>
                </div>
            </div>

            <div class="spectrogram-container">
                <canvas id="spectrogramCanvas" class="spectrogram-canvas" width="1000" height="400"></canvas>
                <div class="frequency-labels">
                    <span>0Hz</span>
                    <span>1kHz</span>
                    <span>2kHz</span>
                    <span>4kHz</span>
                    <span>8kHz</span>
                    <span>16kHz</span>
                    <span>20kHz+</span>
                </div>
            </div>

            <div class="analysis-info">
                <div class="info-card">
                    <div class="info-value" id="peakFreq">--</div>
                    <div class="info-label">Peak Frequency</div>
                </div>
                <div class="info-card">
                    <div class="info-value" id="bandwidth">--</div>
                    <div class="info-label">Bandwidth</div>
                </div>
                <div class="info-card">
                    <div class="info-value" id="harmonics">--</div>
                    <div class="info-label">Harmonics</div>
                </div>
                <div class="info-card">
                    <div class="info-value" id="soundType">--</div>
                    <div class="info-label">Sound Classification</div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="clearSpectrogram()">üóëÔ∏è Clear</button>
                <button class="btn btn-primary" onclick="saveSpectrogram()">üíæ Save Image</button>
                <button class="btn btn-secondary" onclick="toggleAnimation()">‚èØÔ∏è Toggle Animation</button>
            </div>
        </div>
    </div>

    <script>
        let audioContext;
        let analyser;
        let dataArray;
        let canvas;
        let ctx;
        let animationId;
        let isAnimating = false;
        let currentSound = null;
        let spectrogramData = [];
        let timeOffset = 0;

        // Initialize canvas and audio context
        function initializeSpectrogram() {
            canvas = document.getElementById('spectrogramCanvas');
            if (!canvas) {
                console.error('Canvas not found');
                return;
            }
            
            ctx = canvas.getContext('2d');
            
            // Set canvas dimensions properly
            canvas.width = 1000;
            canvas.height = 400;
            
            clearSpectrogram();
            console.log('üéµ Spectrogram canvas initialized');
        }

        // Authentic bird call frequency patterns based on ornithological research
        const birdCallPatterns = {
            // Songbirds - complex melodic patterns
            'robin': {
                type: 'songbird',
                fundamentals: [2400, 3200, 4800, 6400], // American Robin authentic frequencies
                harmonics: [4800, 6400, 9600, 12800],
                modulation: { rate: 6, depth: 0.4, tremolo: true },
                bandwidth: '2.4-12.8kHz',
                classification: 'Melodic Songbird',
                callType: 'Territorial Song',
                duration: 2.5
            },
            'sparrow': {
                type: 'songbird',
                fundamentals: [3200, 4800, 7200, 9600], // House Sparrow chirp sequence
                harmonics: [6400, 9600, 14400, 19200],
                modulation: { rate: 14, depth: 0.6, burst: true },
                bandwidth: '3.2-19.2kHz',
                classification: 'Rapid Chirping Bird',
                callType: 'Social Call',
                duration: 0.8
            },
            'cardinal': {
                type: 'songbird',
                fundamentals: [1600, 2400, 3600, 4800], // Northern Cardinal whistle
                harmonics: [3200, 4800, 7200, 9600],
                modulation: { rate: 4, depth: 0.15, pure: true },
                bandwidth: '1.6-9.6kHz',
                classification: 'Pure Whistling Bird',
                callType: 'Territorial Whistle',
                duration: 3.2
            },
            'owl': {
                type: 'raptor',
                fundamentals: [300, 450, 600, 900], // Great Horned Owl hoot
                harmonics: [600, 900, 1200, 1800],
                modulation: { rate: 1, depth: 0.05, resonant: true },
                bandwidth: '0.3-1.8kHz',
                classification: 'Deep Hooting Bird',
                callType: 'Territorial Hoot',
                duration: 4.0
            },
            'canary': {
                type: 'songbird',
                fundamentals: [2800, 4200, 6300, 8400], // Domestic Canary trill
                harmonics: [5600, 8400, 12600, 16800],
                modulation: { rate: 18, depth: 0.7, trill: true },
                bandwidth: '2.8-16.8kHz',
                classification: 'Ornate Singing Bird',
                callType: 'Complex Song',
                duration: 4.5
            },
            'crow': {
                type: 'corvid',
                fundamentals: [480, 720, 960, 1440], // American Crow caw
                harmonics: [960, 1440, 1920, 2880],
                modulation: { rate: 2, depth: 0.25, harsh: true },
                bandwidth: '0.48-2.88kHz',
                classification: 'Harsh Cawing Bird',
                callType: 'Alarm Call',
                duration: 1.2
            },
            
            // Additional authentic bird species
            'bluejay': {
                type: 'corvid',
                fundamentals: [800, 1600, 2400, 3600],
                harmonics: [1600, 3200, 4800, 7200],
                modulation: { rate: 8, depth: 0.4, raucous: true },
                bandwidth: '0.8-7.2kHz',
                classification: 'Loud Corvid',
                callType: 'Alert Call',
                duration: 1.8
            },
            'mockingbird': {
                type: 'mimic',
                fundamentals: [1800, 3600, 5400, 7200],
                harmonics: [3600, 7200, 10800, 14400],
                modulation: { rate: 25, depth: 0.8, mimic: true },
                bandwidth: '1.8-14.4kHz',
                classification: 'Mimicking Songbird',
                callType: 'Varied Repertoire',
                duration: 6.0
            },
            'wren': {
                type: 'songbird',
                fundamentals: [4000, 6000, 8000, 10000],
                harmonics: [8000, 12000, 16000, 20000],
                modulation: { rate: 20, depth: 0.6, bright: true },
                bandwidth: '4-20kHz',
                classification: 'High-Pitched Songbird',
                callType: 'Energetic Song',
                duration: 3.5
            },
            
            // Instruments with complex harmonic series
            'violin': {
                type: 'instrument',
                fundamentals: [196, 294, 440, 659],
                harmonics: [392, 588, 880, 1318, 1760, 2637],
                modulation: { rate: 6, depth: 0.1 },
                bandwidth: '0.2-8kHz',
                classification: 'String Instrument'
            },
            'piano': {
                type: 'instrument',
                fundamentals: [262, 330, 392, 523],
                harmonics: [524, 660, 784, 1046, 1320, 1568],
                modulation: { rate: 0, depth: 0 },
                bandwidth: '0.3-4kHz',
                classification: 'Percussive'
            },
            'flute': {
                type: 'instrument',
                fundamentals: [262, 523, 1046],
                harmonics: [524, 1046, 2092],
                modulation: { rate: 4, depth: 0.05 },
                bandwidth: '0.3-4kHz',
                classification: 'Wind Instrument'
            },
            'guitar': {
                type: 'instrument',
                fundamentals: [82, 110, 147, 196, 247, 330],
                harmonics: [164, 220, 294, 392, 494, 660],
                modulation: { rate: 0, depth: 0 },
                bandwidth: '0.08-3kHz',
                classification: 'String Instrument'
            },
            'trumpet': {
                type: 'instrument',
                fundamentals: [233, 349, 466, 698],
                harmonics: [466, 698, 932, 1396, 1864],
                modulation: { rate: 5, depth: 0.1 },
                bandwidth: '0.2-6kHz',
                classification: 'Brass Instrument'
            },
            'cello': {
                type: 'instrument',
                fundamentals: [65, 98, 147, 220],
                harmonics: [130, 196, 294, 440, 660],
                modulation: { rate: 4, depth: 0.08 },
                bandwidth: '0.06-2kHz',
                classification: 'String Instrument'
            },
            
            // Natural sounds
            'whistle': {
                type: 'natural',
                fundamentals: [1500, 2100, 3000],
                harmonics: [3000, 4200, 6000],
                modulation: { rate: 2, depth: 0.1 },
                bandwidth: '1.5-6kHz',
                classification: 'Pure Tone'
            },
            'glass': {
                type: 'natural',
                fundamentals: [440],
                harmonics: [880, 1320, 1760, 2200],
                modulation: { rate: 0, depth: 0 },
                bandwidth: '0.44-2.2kHz',
                classification: 'Resonant'
            },
            'water': {
                type: 'natural',
                fundamentals: [2000, 4000, 8000],
                harmonics: [4000, 8000, 16000],
                modulation: { rate: 20, depth: 0.8 },
                bandwidth: '2-16kHz',
                classification: 'Broadband'
            },
            'wind': {
                type: 'natural',
                fundamentals: [100, 300, 800],
                harmonics: [200, 600, 1600],
                modulation: { rate: 1, depth: 0.6 },
                bandwidth: '0.1-3kHz',
                classification: 'Noise-like'
            },
            'rain': {
                type: 'natural',
                fundamentals: [500, 2000, 8000],
                harmonics: [1000, 4000, 16000],
                modulation: { rate: 30, depth: 0.9 },
                bandwidth: '0.5-20kHz',
                classification: 'White Noise'
            },
            'thunder': {
                type: 'natural',
                fundamentals: [20, 50, 100],
                harmonics: [40, 100, 200, 400],
                modulation: { rate: 0.5, depth: 0.7 },
                bandwidth: '20Hz-1kHz',
                classification: 'Low Frequency'
            }
        };

        // Chrome Music Lab inspired bird call generator with authentic frequency patterns
        function generateBirdCall(birdType) {
            console.log(`Starting bird call generation for: ${birdType}`);
            
            // Clear previous active states
            document.querySelectorAll('.sound-preset').forEach(preset => {
                preset.classList.remove('active');
            });
            
            // Set current preset as active
            if (typeof event !== 'undefined' && event.target) {
                event.target.classList.add('active');
            }
            
            currentSound = birdType;
            const pattern = birdCallPatterns[birdType] || soundPatterns[birdType];
            
            if (!pattern) {
                console.error(`Pattern not found for: ${birdType}`);
                console.log('Available bird patterns:', Object.keys(birdCallPatterns));
                console.log('Available sound patterns:', Object.keys(soundPatterns));
                return;
            }
            
            console.log(`Generating authentic ${birdType} call pattern:`, pattern);
            
            // Update analysis info with authentic bird data
            const peakFreqElement = document.getElementById('peakFreq');
            const bandwidthElement = document.getElementById('bandwidth');
            const harmonicsElement = document.getElementById('harmonics');
            const soundTypeElement = document.getElementById('soundType');
            
            if (peakFreqElement) peakFreqElement.textContent = pattern.fundamentals[0] + 'Hz';
            if (bandwidthElement) bandwidthElement.textContent = pattern.bandwidth;
            if (harmonicsElement) harmonicsElement.textContent = pattern.harmonics.length + ' harmonics';
            if (soundTypeElement) soundTypeElement.textContent = pattern.classification;
            
            // Store current sound before clearing
            const soundToAnimate = birdType;
            
            // Clear canvas and prepare for authentic bird visualization
            spectrogramData = [];
            timeOffset = 0;
            
            // Stop any existing animation
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            // Clear canvas without resetting currentSound
            if (canvas && ctx) {
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#0f0f23');
                gradient.addColorStop(1, '#1a1a2e');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            
            // Ensure currentSound is set
            currentSound = soundToAnimate;
            
            // Start Chrome Music Lab style animation with bird-specific patterns
            isAnimating = true;
            console.log('Starting animation for:', currentSound);
            animateBirdSpectrogram();
        }

        // Legacy function for instruments and natural sounds
        function generateSpectrogram(soundType) {
            generateBirdCall(soundType);
        }

        // Chrome Music Lab authentic bird call animation with ornithological accuracy
        function animateBirdSpectrogram() {
            if (!isAnimating || !currentSound) {
                console.log('Animation stopped: isAnimating=', isAnimating, 'currentSound=', currentSound);
                return;
            }
            
            const pattern = birdCallPatterns[currentSound] || soundPatterns[currentSound];
            if (!pattern) {
                console.error(`No pattern found for: ${currentSound}`);
                return;
            }
            
            if (!canvas || !ctx) {
                console.error('Canvas not available for animation');
                return;
            }
            
            // High-resolution frequency analysis (Chrome Music Lab style)
            const freqBins = 512; // Higher resolution for bird call details
            const timeSlice = new Array(freqBins).fill(0);
            const maxFreq = 22050; // Nyquist frequency
            
            // Calculate call progression based on authentic bird behavior
            const duration = pattern.duration || 3.0; // Default duration
            const callProgress = (timeOffset * 0.02) % duration;
            const callPhase = callProgress / duration;
            
            // Generate authentic bird frequency patterns
            pattern.fundamentals.forEach((freq, index) => {
                const binIndex = Math.floor((freq / maxFreq) * freqBins);
                if (binIndex < freqBins) {
                    let amplitude = 0.9 - (index * 0.15);
                    
                    // Apply bird-specific modulation patterns
                    if (pattern.modulation.tremolo) {
                        amplitude *= (1 + pattern.modulation.depth * Math.sin(timeOffset * pattern.modulation.rate * 0.2));
                    }
                    
                    if (pattern.modulation.burst && pattern.type === 'songbird') {
                        const burstPattern = Math.sin(callPhase * Math.PI * 8);
                        amplitude *= Math.max(0, burstPattern);
                    }
                    
                    if (pattern.modulation.trill && currentSound === 'canary') {
                        amplitude *= (1 + 0.4 * Math.sin(timeOffset * 0.8));
                    }
                    
                    // Natural variation for authentic bird behavior
                    amplitude *= (0.85 + Math.random() * 0.3);
                    
                    // Sharp attack/decay for bird calls
                    if (callPhase < 0.1) amplitude *= callPhase / 0.1; // Attack
                    if (callPhase > 0.9) amplitude *= (1 - callPhase) / 0.1; // Decay
                    
                    timeSlice[binIndex] = Math.max(0, Math.min(1, amplitude));
                    
                    // Frequency spread for natural resonance
                    const spread = pattern.type === 'corvid' ? 4 : 2;
                    for (let i = -spread; i <= spread; i++) {
                        const nearbyBin = binIndex + i;
                        if (nearbyBin >= 0 && nearbyBin < freqBins) {
                            const spreadAmp = amplitude * Math.exp(-(i*i) / (spread*spread/2));
                            timeSlice[nearbyBin] = Math.max(timeSlice[nearbyBin], spreadAmp);
                        }
                    }
                }
            });
            
            // Add authentic harmonics with bird-specific characteristics
            pattern.harmonics.forEach((freq, index) => {
                const binIndex = Math.floor((freq / maxFreq) * freqBins);
                if (binIndex < freqBins) {
                    let amplitude = 0.5 - (index * 0.08);
                    
                    // Harmonic modulation varies by bird type
                    if (pattern.type === 'songbird') {
                        amplitude *= (0.8 + 0.2 * Math.sin(timeOffset * 0.15 + index));
                    }
                    
                    amplitude *= (0.7 + Math.random() * 0.3);
                    timeSlice[binIndex] = Math.max(timeSlice[binIndex], amplitude);
                }
            });
            
            // Add formant frequencies for realistic bird vocal tract simulation
            if (pattern.type === 'songbird') {
                const formants = [1200, 2400, 3600]; // Typical songbird formants
                formants.forEach((freq, index) => {
                    const binIndex = Math.floor((freq / maxFreq) * freqBins);
                    if (binIndex < freqBins) {
                        const formantAmp = 0.3 - (index * 0.1);
                        timeSlice[binIndex] += formantAmp * (0.8 + Math.random() * 0.4);
                    }
                });
            }
            
            // Store time slice and maintain scrolling window
            spectrogramData.push([...timeSlice]);
            
            const maxSlices = Math.floor(canvas.width / 3); // Smooth scrolling
            if (spectrogramData.length > maxSlices) {
                spectrogramData.shift();
            }
            
            // Render with Chrome Music Lab color mapping
            renderBirdSpectrogram();
            
            timeOffset++;
            
            // Continue animation if still active
            if (isAnimating) {
                animationId = requestAnimationFrame(animateBirdSpectrogram);
            } else {
                console.log('Animation stopped by user');
            }
        }

        // Legacy animation function
        function animateSpectrogram() {
            animateBirdSpectrogram();
        }

        // 3D Chrome Music Lab rendering with bird shape recognition
        function renderBirdSpectrogram() {
            if (!canvas || !ctx) {
                console.error('Canvas not initialized');
                return;
            }
            
            // 3D depth background with perspective
            const gradient = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, Math.max(canvas.width, canvas.height));
            gradient.addColorStop(0, '#0a0a0a');
            gradient.addColorStop(0.7, '#1a1a2e');
            gradient.addColorStop(1, '#0f0f23');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 3D frequency grid with depth perception
            ctx.strokeStyle = 'rgba(116, 235, 213, 0.15)';
            ctx.lineWidth = 0.5;
            const freqMarkers = [1000, 2000, 4000, 8000, 16000];
            freqMarkers.forEach((freq, index) => {
                const y = canvas.height - (freq / 22050) * canvas.height;
                const depth = 1 - (index * 0.1); // 3D depth effect
                ctx.globalAlpha = depth;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            });
            ctx.globalAlpha = 1;
            
            if (spectrogramData.length === 0) return;
            
            const sliceWidth = Math.max(1.5, canvas.width / spectrogramData.length);
            const freqBins = spectrogramData[0].length;
            const binHeight = canvas.height / freqBins;
            
            // Detect bird-like frequency patterns for shape rendering
            const birdShapes = detectBirdShapes(spectrogramData);
            
            // 3D Chrome Music Lab rendering with bird shape visualization
            spectrogramData.forEach((timeSlice, timeIndex) => {
                const x = timeIndex * sliceWidth;
                const depth = 1 - (timeIndex / spectrogramData.length) * 0.3; // 3D depth perception
                
                timeSlice.forEach((magnitude, freqIndex) => {
                    if (magnitude > 0.02) {
                        const y = canvas.height - (freqIndex * binHeight);
                        const frequency = (freqIndex / freqBins) * 22050;
                        const intensity = Math.min(1, magnitude);
                        
                        // 3D perspective scaling
                        const scale = 0.7 + (depth * 0.3);
                        const pixelWidth = Math.ceil(sliceWidth * scale);
                        const pixelHeight = Math.ceil(binHeight * scale);
                        
                        // Bird-frequency optimized color scheme with 3D depth
                        let hue, saturation, lightness;
                        if (frequency < 1000) {
                            hue = 240 + (intensity * 20);
                            saturation = 80 + (intensity * 20);
                            lightness = (25 + (intensity * 40)) * depth;
                        } else if (frequency < 4000) {
                            hue = 180 - (intensity * 120);
                            saturation = 70 + (intensity * 30);
                            lightness = (30 + (intensity * 50)) * depth;
                        } else {
                            hue = 60 - (intensity * 60);
                            saturation = 85 + (intensity * 15);
                            lightness = (35 + (intensity * 45)) * depth;
                        }
                        
                        // Enhanced 3D glow for bird call peaks
                        if (intensity > 0.7) {
                            lightness = Math.min(85, lightness + 15 * depth);
                            saturation = Math.min(100, saturation + 10);
                            
                            // 3D glow effect
                            ctx.shadowColor = `hsl(${hue}, ${saturation}%, ${lightness + 20}%)`;
                            ctx.shadowBlur = 4 * scale;
                            ctx.globalAlpha = depth;
                        }
                        
                        ctx.fillStyle = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                        ctx.fillRect(x, y, pixelWidth, pixelHeight);
                        
                        ctx.shadowBlur = 0;
                        ctx.globalAlpha = 1;
                    }
                });
            });
            
            // Render bird shapes on top
            renderBirdShapes(birdShapes);
        }
        
        // Detect hummingbird and bird-like patterns in frequency data
        function detectBirdShapes(data) {
            const shapes = [];
            const threshold = 0.5;
            
            for (let timeIndex = 0; timeIndex < data.length - 10; timeIndex += 5) {
                const slice = data[timeIndex];
                const peaks = [];
                
                // Find frequency peaks that form bird-like patterns
                for (let freqIndex = 10; freqIndex < slice.length - 10; freqIndex++) {
                    if (slice[freqIndex] > threshold) {
                        const neighbors = slice.slice(freqIndex - 5, freqIndex + 5);
                        const isLocalMax = slice[freqIndex] === Math.max(...neighbors);
                        if (isLocalMax) {
                            peaks.push({ freq: freqIndex, amplitude: slice[freqIndex] });
                        }
                    }
                }
                
                // Detect hummingbird-like rapid frequency changes
                if (peaks.length >= 3) {
                    const freqSpread = Math.max(...peaks.map(p => p.freq)) - Math.min(...peaks.map(p => p.freq));
                    const avgAmplitude = peaks.reduce((sum, p) => sum + p.amplitude, 0) / peaks.length;
                    
                    if (freqSpread > 50 && avgAmplitude > 0.6) {
                        shapes.push({
                            type: 'hummingbird',
                            x: timeIndex,
                            peaks: peaks,
                            intensity: avgAmplitude
                        });
                    }
                }
            }
            
            return shapes;
        }
        
        // Render bird shape overlays
        function renderBirdShapes(shapes) {
            shapes.forEach(shape => {
                if (shape.type === 'hummingbird') {
                    const x = (shape.x / spectrogramData.length) * canvas.width;
                    const intensity = shape.intensity;
                    
                    // Draw hummingbird silhouette
                    ctx.globalAlpha = 0.3 + (intensity * 0.4);
                    ctx.strokeStyle = `hsl(${60 + intensity * 120}, 80%, 70%)`;
                    ctx.lineWidth = 2;
                    
                    // Hummingbird body
                    ctx.beginPath();
                    const bodyY = canvas.height * 0.6;
                    ctx.ellipse(x, bodyY, 8, 4, 0, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // Rapid wing beats
                    for (let wing = 0; wing < 2; wing++) {
                        const wingX = x + (wing === 0 ? -6 : 6);
                        const wingY = bodyY - 2;
                        const wingPhase = (timeOffset * 0.5 + wing * Math.PI) % (Math.PI * 2);
                        const wingSpan = 12 + Math.sin(wingPhase) * 8;
                        
                        ctx.beginPath();
                        ctx.ellipse(wingX, wingY, wingSpan, 3, wingPhase * 0.2, 0, Math.PI * 2);
                        ctx.stroke();
                    }
                    
                    // Long beak
                    ctx.beginPath();
                    ctx.moveTo(x - 8, bodyY);
                    ctx.lineTo(x - 15, bodyY - 1);
                    ctx.stroke();
                    
                    ctx.globalAlpha = 1;
                }
            });
        }

        // Legacy rendering function
        function renderSpectrogramData() {
            renderBirdSpectrogram();
        }

        function clearSpectrogram() {
            if (!canvas || !ctx) {
                console.log('Canvas not ready for clearing');
                return;
            }
            
            console.log('Clearing spectrogram...');
            
            // Clear with gradient background
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#0f0f23');
            gradient.addColorStop(1, '#1a1a2e');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Add frequency grid lines
            ctx.strokeStyle = 'rgba(116, 235, 213, 0.2)';
            ctx.lineWidth = 1;
            for (let i = 1; i < 6; i++) {
                const y = (i / 6) * canvas.height;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // Reset analysis info
            document.getElementById('peakFreq').textContent = '--';
            document.getElementById('bandwidth').textContent = '--';
            document.getElementById('harmonics').textContent = '--';
            document.getElementById('soundType').textContent = '--';
            
            // Clear active states
            document.querySelectorAll('.sound-preset').forEach(preset => {
                preset.classList.remove('active');
            });
            
            spectrogramData = [];
            currentSound = null;
            
            // Stop animation
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            isAnimating = false;
        }

        function toggleAnimation() {
            if (isAnimating) {
                isAnimating = false;
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
            } else if (currentSound) {
                isAnimating = true;
                animateSpectrogram();
            }
        }

        function saveSpectrogram() {
            const canvas = document.getElementById('spectrogramCanvas');
            const link = document.createElement('a');
            link.download = `savo-studio-spectrogram-${currentSound || 'analysis'}-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        function startMicrophone() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('Microphone access not supported in this browser');
                return;
            }
            
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    
                    const source = audioContext.createMediaStreamSource(stream);
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 512;
                    
                    source.connect(analyser);
                    dataArray = new Uint8Array(analyser.frequencyBinCount);
                    
                    currentSound = 'microphone';
                    clearSpectrogram();
                    spectrogramData = [];
                    timeOffset = 0;
                    
                    document.getElementById('soundType').textContent = 'Live Audio';
                    
                    isAnimating = true;
                    animateMicrophoneSpectrogram();
                })
                .catch(err => {
                    console.error('Error accessing microphone:', err);
                    alert('Could not access microphone. Please check permissions.');
                });
        }

        function animateMicrophoneSpectrogram() {
            if (!isAnimating || !analyser) return;
            
            analyser.getByteFrequencyData(dataArray);
            
            // Convert to normalized array
            const normalizedData = Array.from(dataArray).map(value => value / 255);
            
            // Store this time slice
            spectrogramData.push(normalizedData);
            
            // Keep only recent data
            const maxSlices = Math.floor(canvas.width / 2);
            if (spectrogramData.length > maxSlices) {
                spectrogramData.shift();
            }
            
            // Find peak frequency
            let maxIndex = 0;
            let maxValue = 0;
            normalizedData.forEach((value, index) => {
                if (value > maxValue) {
                    maxValue = value;
                    maxIndex = index;
                }
            });
            
            // Update analysis info
            const peakFreq = Math.round((maxIndex / normalizedData.length) * 22050);
            document.getElementById('peakFreq').textContent = peakFreq + 'Hz';
            document.getElementById('bandwidth').textContent = 'Live';
            document.getElementById('harmonics').textContent = normalizedData.filter(v => v > 0.3).length;
            
            // Render the spectrogram
            renderSpectrogramData();
            
            animationId = requestAnimationFrame(animateMicrophoneSpectrogram);
        }

        // File upload handling
        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                processAudioFile(files[0]);
            }
        }

        function processAudioFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                audioContext.decodeAudioData(e.target.result)
                    .then(audioBuffer => {
                        currentSound = file.name;
                        document.getElementById('soundType').textContent = 'Audio File';
                        
                        // Process audio file data
                        analyzeAudioBuffer(audioBuffer);
                    })
                    .catch(err => {
                        console.error('Error decoding audio file:', err);
                        alert('Could not process audio file');
                    });
            };
            reader.readAsArrayBuffer(file);
        }

        function analyzeAudioBuffer(audioBuffer) {
            const channelData = audioBuffer.getChannelData(0);
            const sampleRate = audioBuffer.sampleRate;
            const windowSize = 1024;
            const hopSize = 512;
            
            clearSpectrogram();
            spectrogramData = [];
            
            // Process audio in chunks
            for (let i = 0; i < channelData.length - windowSize; i += hopSize) {
                const chunk = channelData.slice(i, i + windowSize);
                const spectrum = performFFT(chunk);
                spectrogramData.push(spectrum);
                
                // Limit data for performance
                if (spectrogramData.length > 500) break;
            }
            
            // Render static spectrogram
            renderSpectrogramData();
            
            // Update analysis info
            const peakBin = findPeakFrequency(spectrogramData);
            const peakFreq = Math.round((peakBin / windowSize) * sampleRate);
            document.getElementById('peakFreq').textContent = peakFreq + 'Hz';
            document.getElementById('bandwidth').textContent = 'File Analysis';
        }

        // Simple FFT implementation for demonstration
        function performFFT(samples) {
            const N = samples.length;
            const spectrum = new Array(N/2).fill(0);
            
            for (let k = 0; k < N/2; k++) {
                let real = 0, imag = 0;
                for (let n = 0; n < N; n++) {
                    const angle = -2 * Math.PI * k * n / N;
                    real += samples[n] * Math.cos(angle);
                    imag += samples[n] * Math.sin(angle);
                }
                spectrum[k] = Math.sqrt(real * real + imag * imag) / N;
            }
            
            // Normalize
            const max = Math.max(...spectrum);
            return spectrum.map(val => max > 0 ? val / max : 0);
        }

        function findPeakFrequency(spectrogramData) {
            const avgSpectrum = new Array(spectrogramData[0].length).fill(0);
            
            spectrogramData.forEach(spectrum => {
                spectrum.forEach((val, i) => {
                    avgSpectrum[i] += val;
                });
            });
            
            avgSpectrum.forEach((val, i) => {
                avgSpectrum[i] = val / spectrogramData.length;
            });
            
            let maxIndex = 0;
            let maxValue = 0;
            avgSpectrum.forEach((val, i) => {
                if (val > maxValue) {
                    maxValue = val;
                    maxIndex = i;
                }
            });
            
            return maxIndex;
        }

        // Drag and drop handling
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('audio/')) {
                processAudioFile(files[0]);
            }
        });

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeSpectrogram();
            console.log('üéµ Natural Sound Spectrogram initialized - Chrome Music Lab inspired');
        });
        
        // Also initialize on window load as fallback
        window.addEventListener('load', function() {
            if (!canvas) {
                initializeSpectrogram();
            }
        });
    </script>
</body>
</html>
